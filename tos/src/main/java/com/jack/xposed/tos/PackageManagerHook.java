package com.jack.xposed.tos;

import android.content.pm.PackageInfo;
import android.content.pm.Signature;

import java.lang.reflect.Method;

import de.robv.android.xposed.XC_MethodHook;
import de.robv.android.xposed.callbacks.XC_LoadPackage;

import static de.robv.android.xposed.XposedBridge.hookMethod;
import static de.robv.android.xposed.XposedHelpers.findClass;

class PackageManagerHook {
    private static final Signature VERSION_6_05 = new Signature("3082026f308201d8a00302010202044ff45bcf300d06092a864886f70d0101050500307b310c300a06035504061303383532310e300c060355040813054368696e613112301006035504071309486f6e67204b6f6e6731193017060355040a13104d61642048656164204c696d6974656431143012060355040b130b4d6f62696c652047616d65311630140603550403130d546572656e6365205473616e673020170d3132303730343135303535315a180f32303632303632323135303535315a307b310c300a06035504061303383532310e300c060355040813054368696e613112301006035504071309486f6e67204b6f6e6731193017060355040a13104d61642048656164204c696d6974656431143012060355040b130b4d6f62696c652047616d65311630140603550403130d546572656e6365205473616e6730819f300d06092a864886f70d010101050003818d003081890281810089adafb3a3072e35d55608931ed94d9ef628e913224d275af4ad35d69ec8a57637848db8235961be1e1fe2d7f66655dbe962433b79180f492fa65ec3364d1039b6c3a313449701b8600cac255a02aec6935515063de2efac5acdd6e169b86a9a3a05d6c0e50d796ffed62829c763f011b35d37c1db0b861e1d9a1c125eb7debd0203010001300d06092a864886f70d010105050003818100500ea259a144f04fcb6aa1ae3d63ef0dade0c6abbc98359f0a91753f12787514edd1f3f28ae78513def110ebf4a68523875525091cad0ab58d087569c6071acf3cddb1a1d2c461c318c1aaba52bb0c0d550243f9190ab0277cf73dcaa01408aedd7a9d8c0eba1328ed03fa592731c2db2036c47ea38d13d2b9b9b5da0959eb38");
    private static final Signature VERSION_7_01 = new Signature("3082030d308201f5a00302010202043aa272c3300d06092a864886f70d01010b05003037310b30090603550406130255533110300e060355040a1307416e64726f6964311630140603550403130d416e64726f6964204465627567301e170d3134303530323133353031335a170d3434303432343133353031335a3037310b30090603550406130255533110300e060355040a1307416e64726f6964311630140603550403130d416e64726f696420446562756730820122300d06092a864886f70d01010105000382010f003082010a02820101009c21d40604944b93c212397afe6d8c9e9e1f983a64fb26f67c8034dad8591aa5314860e28f3f599a2dab35fb0679699a29a90aa088a8cb3c2ad963913fd554be295a42b45cbbdc9cfdd6a116efe7cecf1688f74164561e81c9971f8c3570b97135194a7cde0f580ae338d8bff8c1977bd2bcb27b70b33e7cbf0bccfb66ea7a200756ba11a70083a6bd3caf8fce1c5f58b5e13f8698aeb8f699bb26061ad0d368bd35213c0e8f3f4ab824489eff824d0ba6bd86c221f14d996bbf2516805315ce2cf50e827da274ba852e9c2fc19c1945a6ce5a1fd27a38b637561c717957536f23ef23655b4d790b7d062d15550cccc9f5ddb1296f96ac57f8b3c26f48fcefcb0203010001a321301f301d0603551d0e0416041474ba56530c4e37ea2e9d54b66e9bb73e5348c92f300d06092a864886f70d01010b05000382010100222d192f5595e7c685c9bb0a2d3b1a9c21276659436869bf413446d068c0eeef29d57b731c88399fcd3d2f689eb9f5c4cf19db5741d798d08a17c6c10311869d8ace481b6b49bd60cd2f54941db0156927ec702f5fd47291a1b19a6881886d1cddc6c2b9b5958cffacad27065f42095763b06d55279fcf4a4a8063bb1612eaf952910b5a6ccc356d2a755a9547ce70fd1486152eaa65f9c2de31b2bec31dc622611a1fe2eff691cf2ed8f62806a9545143e5318086ab44eb4eea9d51973b0aa6053181d2ec04aef7141a8df75c48a7a9a8b3d4278daf2dfdf4e002b970e53946d8cbb254ace26162a71276451535f82e03781a0cdd3cfd5082a0290c0bd443bc");

    public PackageManagerHook(XC_LoadPackage.LoadPackageParam packageParam) {
        Class clazz = findClass("android.app.ApplicationPackageManager", packageParam.classLoader);

        for (Method method : clazz.getDeclaredMethods()) {
            String methodName = method.getName();
            if (methodName.equals("getPackageInfo")) {
                hookMethod(method, new XC_MethodHook(XC_MethodHook.PRIORITY_LOWEST) {
                    @Override
                    protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                        PackageInfo packageInfo = (PackageInfo) param.getResult();

                        if (packageInfo.packageName.equals("com.madhead.tos.zh")) {
                            if (packageInfo.signatures != null && packageInfo.signatures.length == 1) {
                                if (packageInfo.versionName.equals("6.05"))
                                    packageInfo.signatures[0] = VERSION_6_05;
                                else if (packageInfo.versionName.equals("7.01"))
                                    packageInfo.signatures[0] = VERSION_7_01;
                            }
                        }
                    }
                });
            }
        }
    }
}
